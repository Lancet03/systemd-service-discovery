# ===== Stage 1: сборка C++ проекта через CMake + build.sh =====
FROM registry.fedoraproject.org/fedora:40 AS build

RUN dnf -y install cmake make gcc gcc-c++ && dnf clean all

WORKDIR ./

# исходники и скрипт сборки
COPY src/ ./src/
COPY scripts/build.sh ./scripts/build.sh

RUN chmod +x ./scripts/build.sh && ./scripts/build.sh Release

# ===== Stage 2: runtime со systemd =====
FROM registry.fedoraproject.org/fedora:40

ENV container=podman

RUN dnf -y install systemd curl hostname iputils && dnf clean all

VOLUME ["/sys/fs/cgroup", "/run", "/tmp"]

WORKDIR /app

# готовый бинарник из первого стейджа
COPY --from=build /build/worker /usr/local/bin/worker

# скрипты
COPY scripts/container-init.sh /usr/local/bin/container-init.sh
COPY scripts/register.sh /usr/local/bin/register.sh

# unit-файлы systemd
COPY systemd/worker.service systemd/heartbeat.service systemd/heartbeat.timer \
     /etc/systemd/system/

RUN chmod +x /usr/local/bin/worker \
             /usr/local/bin/container-init.sh \
             /usr/local/bin/register.sh \
    && ln -s /etc/systemd/system/worker.service \
             /etc/systemd/system/multi-user.target.wants/worker.service \
    && ln -s /etc/systemd/system/heartbeat.timer \
             /etc/systemd/system/timers.target.wants/heartbeat.timer

STOPSIGNAL SIGRTMIN+3
CMD ["/usr/local/bin/container-init.sh"]
